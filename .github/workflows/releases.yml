name: Release

on:
  push:
    tags: ["v*"]

permissions:
  contents: write

jobs:
  release:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, windows-latest]
        include:
          - os: ubuntu-22.04
            qt-arch: gcc_64
          - os: windows-latest
            qt-arch: win64_msvc2019_64

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v6
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install deps (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build cmake patchelf curl \
            libgl1-mesa-dev libglu1-mesa-dev \
            libxkbcommon-x11-0 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 \
            libxcb-render-util0 libxcb-xinerama0 libxcb-cursor0

      - name: Configure MSVC (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Setup vcpkg (Windows)
        if: runner.os == 'Windows'
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgJsonGlob: '**/vcpkg.json'
          runVcpkgInstall: true


      - name: Install Qt6
        uses: jurplel/install-qt-action@v3
        with:
          version: "6.5.0"
          arch: ${{ matrix.qt-arch }}
          cache: true

      - name: Configure
        shell: bash
        run: |
          set -euo pipefail
          cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release \
            $([ "${RUNNER_OS}" = "Windows" ] && echo "-DCMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake -DVCPKG_TARGET_TRIPLET=x64-windows")

      - name: Build
        run: cmake --build build --parallel

      - name: Test
        run: ctest --test-dir build --output-on-failure
        shell: bash

      # ---------- Linux: AppImage ----------
      - name: Build AppImage (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          set -x
          
          rm -rf AppDir
          mkdir -p AppDir/usr/bin
          
          cp build/bin/epigimp AppDir/usr/bin/epigimp

          cp packaging/linux/epigimp.desktop AppDir/epigimp.desktop
          cp packaging/linux/epigimp.png AppDir/epigimp.png

          curl -L --retry 5 --retry-all-errors --retry-delay 2 -o linuxdeploy.AppImage \
          https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          curl -L --retry 5 --retry-all-errors --retry-delay 2 -o linuxdeploy-plugin-qt.AppImage \
          https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
          chmod +x linuxdeploy.AppImage linuxdeploy-plugin-qt.AppImage
    
          ./linuxdeploy.AppImage \
            --appdir AppDir \
            -d AppDir/epigimp.desktop \
            -i AppDir/epigimp.png \
            --plugin qt \
            --output appimage
          
          out="$(ls -1 EpiGimp2.0-*.AppImage 2>/dev/null | head -n 1)"
          test -n "$out"
          mv -v "$out" epigimp-linux-x86_64.AppImage
          ls -la epigimp-linux-x86_64.AppImage

      # ---------- Windows: ZIP portable ----------
      - name: Package Windows (zip)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          Set-Location $env:GITHUB_WORKSPACE

          $dist = Join-Path $env:GITHUB_WORKSPACE "dist"
          if (Test-Path $dist) { Remove-Item $dist -Recurse -Force }
          New-Item -ItemType Directory -Path $dist | Out-Null

          $exe = Get-ChildItem -Path "build" -Recurse -Filter "epigimp.exe" | Select-Object -First 1
          if (-not $exe) { throw "epigimp.exe not found under build/." }

          Copy-Item $exe.FullName (Join-Path $dist "epigimp.exe") -Force

          $windeploy = (Get-Command windeployqt.exe -ErrorAction SilentlyContinue).Source
          if (-not $windeploy) { throw "windeployqt.exe not found in PATH" }

          $qtRoot = $env:QT_ROOT_DIR
          $translationDir = if ($qtRoot) { Join-Path $qtRoot "translations" } else { "" }
          $hasTranslations = $translationDir -and (Test-Path (Join-Path $translationDir "qt_ar.qm"))

          if ($hasTranslations) {
            & $windeploy --release --compiler-runtime --dir $dist --translationdir $translationDir (Join-Path $dist "epigimp.exe")
          } else {
            & $windeploy --release --compiler-runtime --dir $dist --no-translations (Join-Path $dist "epigimp.exe")
          }

          Compress-Archive -Path (Join-Path $dist "*") -DestinationPath "epigimp-windows-x86_64.zip" -Force

      - name: Upload Linux asset to GitHub Release
        if: runner.os == 'Linux'
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            epigimp-linux-x86_64.AppImage

      - name: Upload Windows asset to GitHub Release
        if: runner.os == 'Windows'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            epigimp-windows-x86_64.zip
