name: Build EpiGimp2.0

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]
  workflow_dispatch:

jobs:
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        build-type: [Release]

    steps:
      # ------------------------------------------------------------
      # Checkout
      # ------------------------------------------------------------
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # ------------------------------------------------------------
      # Qt 6
      # ------------------------------------------------------------
      - name: üîß Install Qt 6
        uses: jurplel/install-qt-action@v3
        with:
          version: "6.5.0"
          cache: true

      # ------------------------------------------------------------
      # Linux dependencies
      # ------------------------------------------------------------
      - name: üì¶ Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            pkg-config \
            libgl1-mesa-dev \
            libglu1-mesa-dev \
            libxkbcommon-x11-0 \
            libxcb-icccm4 \
            libxcb-image0 \
            libxcb-keysyms1 \
            libxcb-render-util0 \
            libxcb-xinerama0 \
            libxcb-cursor0 \
            libssl-dev \
            zlib1g-dev \
            libzip-dev \
            zipcmp || true

      # ------------------------------------------------------------
      # Windows: MSVC
      # ------------------------------------------------------------
      - name: üî® Setup MSVC
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1

      # ------------------------------------------------------------
      # Windows: vcpkg
      # ------------------------------------------------------------
      - name: üì¶ Setup vcpkg
        if: runner.os == 'Windows'
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: b3dd708d38df5c856fe1c18dc0d59ab771f93921
          vcpkgDirectory: ${{ runner.temp }}/vcpkg
          runVcpkgInstall: false


      - name: üì¶ Install vcpkg dependencies
        if: runner.os == 'Windows'
        run: |
          vcpkg install zlib libzip openssl --triplet x64-windows
        shell: pwsh
        env:
          VCPKG_FORCE_SYSTEM_BINARIES: 1

      # ------------------------------------------------------------
      # Configure CMake
      # ------------------------------------------------------------
      - name: ‚öôÔ∏è Configure (Linux)
        if: runner.os == 'Linux'
        run: |
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=${{ matrix.build-type }}

      - name: ‚öôÔ∏è Configure (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          cmake -S . -B build `
            -G "Visual Studio 17 2022" `
            -A x64 `
            -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake"
      # ------------------------------------------------------------
      # Build
      # ------------------------------------------------------------
      - name: üèóÔ∏è Build
        run: cmake --build build --config ${{ matrix.build-type }} --parallel

      # ------------------------------------------------------------
      # Tests
      # ------------------------------------------------------------
      - name: üß™ Run tests
        run: ctest --test-dir build -C ${{ matrix.build-type }} --output-on-failure

      # ------------------------------------------------------------
      # Artifacts
      # ------------------------------------------------------------
      - name: üì§ Upload artifacts (Linux)
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: epigimp-linux
          path: |
            build/bin/**
          retention-days: 7

      - name: üì§ Upload artifacts (Windows)
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: epigimp-windows
          path: |
            build/bin/**
          retention-days: 7
